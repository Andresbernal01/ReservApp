<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Zahara Studio</title>
    <link rel="stylesheet" href="css/agendas.css">
    <link rel="icon" href="img/Imagotipo Zahara Studio.ico">
    <style>
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            text-align: center;
            line-height: 10px;
        }

        .filters-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters-bar div {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filters-bar input {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: rgba(44, 44, 44, 0.8);
            color: white;
            font-size: 1rem;
        }

        .filters-bar button {
            background: linear-gradient(135deg, #9982BC 0%, #7A6BA8 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .filters-bar button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(153, 130, 188, 0.3);
        }

        #active-filters {
            display: none;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            color: #9982BC;
            font-size: 1.1rem;
            margin: 2rem 0;
        }

        .error {
            text-align: center;
            color: #f44336;
            font-size: 1.1rem;
            margin: 2rem 0;
        }

        @media screen and (max-width: 768px) {
            .filters-bar {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header id="header-container">
        <div class="header-content">
            <a href="admin.html" id="cabeza" class="logo-container">
                <h1 class="header-title">Agenda Zahara Studio</h1>
            </a>
            <button onclick="window.location.href='inicio.html'" class="inicio-btn">Inicio</button>
        </div>
    </header>

    <!-- Barra de filtros -->
    <div class="filters-bar">
        <div>
            <input type="date" id="filter-date">
            <button onclick="filterByDate()">Filtrar por Fecha</button>
        </div>
        <div>
            <input type="text" id="search-input" placeholder="Buscar por nombre o teléfono" onkeypress="handleSearchEnter(event)">
            <button onclick="searchByTerm()">Buscar</button>
        </div>
        <div>
            <button onclick="clearAllFilters()">Limpiar Filtros</button>
        </div>
    </div>

    <!-- Filtros activos -->
    <div id="active-filters"></div>

    <!-- Contenedor de citas -->
    <div id="appointments-container">
        <div class="loading">Cargando citas...</div>
    </div>

    <!-- Botón scroll to top -->
    <button id="scrollTopBtn" onclick="scrollToTop()">↑</button>

    <!-- Scripts -->
    <script src="js/script.js"></script>
    <script src="js/login.js"></script>
    <script>
        // Variables globales
        let currentFilters = { date: null, search: null };

        // Scroll to top functionality
        window.onscroll = function() {
            const btn = document.getElementById('scrollTopBtn');
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Función para filtrar por fecha
        function filterByDate() {
            const date = document.getElementById('filter-date').value;
            if (!date) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            currentFilters.date = date;
            applyCurrentFilters();
        }

        // Función para buscar por término
        function searchByTerm() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) {
                alert('Por favor ingresa un término de búsqueda');
                return;
            }
            
            currentFilters.search = searchTerm;
            applyCurrentFilters();
        }

        // Manejar Enter en el campo de búsqueda
        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                searchByTerm();
            }
        }

        // Aplicar filtros actuales
        function applyCurrentFilters() {
            updateActiveFiltersDisplay();
            
            if (currentFilters.date && currentFilters.search) {
                filterByDateAndSearch(currentFilters.date, currentFilters.search);
            } else if (currentFilters.date) {
                filterAppointmentsByDate(currentFilters.date);
            } else if (currentFilters.search) {
                searchAppointmentsByTerm(currentFilters.search);
            } else {
                loadAppointments();
            }
        }

        // Limpiar todos los filtros
        function clearAllFilters() {
            currentFilters = { date: null, search: null };
            document.getElementById('filter-date').value = '';
            document.getElementById('search-input').value = '';
            updateActiveFiltersDisplay();
            loadAppointments();
        }

        // Función formatDate simplificada
        function formatDateForDisplay(dateString) {
            if (!dateString) return 'Fecha no válida';
            
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Actualizar visualización de filtros activos
        function updateActiveFiltersDisplay() {
            const container = document.getElementById('active-filters');
            if (!container) return;
            
            container.innerHTML = '';

            Object.entries(currentFilters).forEach(([key, value]) => {
                if (value) {
                    const filterDiv = document.createElement('div');
                    filterDiv.style.cssText = `
                        background: #4A90E2;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 6px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 0.9rem;
                    `;
                    
                    const label = key === 'date' ? 'Fecha: ' + formatDateForDisplay(value) : 'Búsqueda: ' + value;
                    
                    filterDiv.innerHTML = `
                        <span>${label}</span>
                        <button style="
                            background: #ff4d4d;
                            border: none;
                            color: white;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 0.8rem;
                            padding: 2px 6px;
                            border-radius: 50%;
                            transition: all 0.2s ease;
                        " 
                        onmouseover="this.style.background='#ff1a1a';" 
                        onmouseout="this.style.background='#ff4d4d';"
                        onclick="removeFilter('${key}')">
                            ✖
                        </button>
                    `;

                    container.appendChild(filterDiv);
                }
            });

            container.style.display = Object.values(currentFilters).some(v => v) ? 'flex' : 'none';
        }

        // Remover filtro específico
        function removeFilter(filterKey) {
            currentFilters[filterKey] = null;
            
            if (filterKey === 'date') {
                document.getElementById('filter-date').value = '';
            } else if (filterKey === 'search') {
                document.getElementById('search-input').value = '';
            }
            
            applyCurrentFilters();
        }

        // Cargar todas las citas
        async function loadAppointments() {
            const container = document.getElementById('appointments-container');
            container.innerHTML = '<div class="loading">Cargando citas...</div>';

            try {
                const response = await fetch('/api/appointments', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('zahara_auth_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                const appointments = await response.json();
                renderAppointments(appointments);
            } catch (error) {
                console.error('Error cargando citas:', error);
                container.innerHTML = '<div class="error">Error al cargar las citas. Verifique su conexión.</div>';
            }
        }

        function renderAppointments(appointments) {
            const container = document.getElementById('appointments-container');
            if (!container) return;
            
            container.innerHTML = '';

            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 1.2rem; margin-top: 2rem;">No hay citas programadas.</p>';
                return;
            }

            const now = new Date();
            const today = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
            today.setHours(0, 0, 0, 0);
            
            const todayStr = today.toISOString().split('T')[0];
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            const formatLocalDate = (dateStr) => {
                const date = new Date(`${dateStr}T00:00:00`);
                return date.toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: 'America/Bogota'
                });
            };

            const todayAppointments = appointments.filter(app => {
                const appDate = new Date(`${app.fecha}T00:00:00`);
                return appDate.toISOString().split('T')[0] === todayStr;
            });

            const tomorrowAppointments = appointments.filter(app => {
                const appDate = new Date(`${app.fecha}T00:00:00`);
                return appDate.toISOString().split('T')[0] === tomorrowStr;
            });

            const upcomingAppointments = appointments.filter(app => {
                const appDate = new Date(`${app.fecha}T00:00:00`);
                return appDate > tomorrow && appDate >= today;
            });

            const sortByTime = (a, b) => a.hora.localeCompare(b.hora);
            todayAppointments.sort(sortByTime);
            tomorrowAppointments.sort(sortByTime);
            upcomingAppointments.sort(sortByTime);

            const renderGroup = (group, title, emoji) => {
                if (group.length === 0) return '';
                
                return `
                    <div class="appointment-group">
                        <h2 style="color: #9982BC; text-align: center; margin-bottom: 2rem; font-size: 1.8rem; font-weight: 700;">
                            ${emoji} ${title} (${group.length})
                        </h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem;">
                            ${group.map(app => `
                                <div class="appointment">
                                    <div class="appointment-info" id="appointment-info-${app.id}">
                                        <p><span class="field-title">Barbero:</span> <span class="field-data" style="font-weight: bold; color: #9982BC;">${app.barbero}</span></p>
                                        <p><span class="field-title">Hora:</span> <span class="field-data">${convertToAMPM(app.hora)}</span></p>
                                        <p><span class="field-title">Nombre:</span> <span class="field-data">${app.nombre} ${app.apellido}</span></p>
                                        <p><span class="field-title">Teléfono:</span> <span class="field-data">${app.telefono}</span></p>
                                        <p><span class="field-title">Fecha:</span> <span class="field-data">${formatLocalDate(app.fecha)}</span></p>
                                        <p><span class="field-title">Servicio:</span> <span class="field-data">${app.servicio}</span></p>
                                        <div class="appointment-actions">
                                            <button onclick="deleteAppointment(${app.id}, '${app.barbero}')">Eliminar</button>
                                            <button onclick="showEditForm(${app.id})">Editar</button>
                                        </div>
                                    </div>
                                    <div class="edit-form" id="edit-form-${app.id}" style="display: none;">
                                        <h3>Editar Cita</h3>
                                        <input type="text" id="edit-name-${app.id}" value="${app.nombre}" placeholder="Nombre">
                                        <input type="text" id="edit-surname-${app.id}" value="${app.apellido}" placeholder="Apellido">
                                        <input type="tel" id="edit-phone-${app.id}" value="${app.telefono}" placeholder="Teléfono">
                                        <input type="date" id="edit-date-${app.id}" value="${app.fecha}">
                                        <input type="time" id="edit-time-${app.id}" value="${app.hora}">
                                        <select id="edit-service-${app.id}">
                                            ${getServiceOptionsForBarbero(app.barbero, app.servicio)}
                                        </select>
                                        <div class="appointment-actions">
                                            <button onclick="saveEdit(${app.id})" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">Guardar</button>
                                            <button onclick="cancelEdit(${app.id})" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">Cancelar</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                ${renderGroup(todayAppointments, 'Citas Hoy', '📅')}
                ${renderGroup(tomorrowAppointments, 'Citas Mañana', '⌛')}
                ${renderGroup(upcomingAppointments, 'Próximas Citas', '🗓️')}
            `;
        }

        // Funciones auxiliares
        function convertToAMPM(hour) {
            const [h, m] = hour.split(':');
            const hours = parseInt(h, 10);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const newHours = hours % 12 || 12;
            return `${newHours}:${m} ${ampm}`;
        }

        function getServiceOptionsForBarbero(barberoNombre, currentService) {
            const serviciosPorBarbero = {
                Giovany: [
                    "Corte de cabello",
                    "Barba", 
                    "Corte y Barba"
                ],
                Danitza: [
                    "Corte",
                    "Depilaciones",
                    "Limpieza facial",
                    "Peinados",
                    "Trenzados",
                    "Colorimetria Artistica",
                    "Maquillaje",
                    "Masajes"
                ]
            };

            const services = serviciosPorBarbero[barberoNombre] || [];
            return services.map(service => 
                `<option value="${service}" ${service === currentService ? 'selected' : ''}>${service}</option>`
            ).join('');
        }

        // Funciones de filtrado
        function filterAppointmentsByDate(date) {
            let url = `/api/appointments/filter?date=${date}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(appointments => {
                    renderFilteredAppointments(appointments);
                })
                .catch(error => {
                    console.error('Error filtrando por fecha:', error);
                    alert('Error al filtrar las citas');
                });
        }

        function searchAppointmentsByTerm(searchTerm) {
            const url = '/api/appointments';
            
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('zahara_auth_token')}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(appointments => {
                const filtered = appointments.filter(appointment => {
                    const fullName = `${appointment.nombre} ${appointment.apellido}`.toLowerCase();
                    return fullName.includes(searchTerm.toLowerCase()) || 
                           appointment.telefono.includes(searchTerm);
                });
                renderFilteredAppointments(filtered);
            })
            .catch(error => {
                console.error('Error buscando citas:', error);
                alert('Error al buscar las citas');
            });
        }

        function filterByDateAndSearch(date, searchTerm) {
            let url = `/api/appointments/filter?date=${date}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(appointments => {
                    const filtered = appointments.filter(appointment => {
                        const fullName = `${appointment.nombre} ${appointment.apellido}`.toLowerCase();
                        return fullName.includes(searchTerm.toLowerCase()) || 
                               appointment.telefono.includes(searchTerm);
                    });
                    renderFilteredAppointments(filtered);
                })
                .catch(error => {
                    console.error('Error combinando filtros:', error);
                    alert('Error al filtrar las citas');
                });
        }

        function renderFilteredAppointments(appointments) {
            const container = document.getElementById('appointments-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 1.2rem; margin-top: 2rem;">No hay resultados para los filtros aplicados.</p>';
                return;
            }
            
            appointments.sort((a, b) => new Date(`${a.fecha}T${a.hora}:00`) - new Date(`${b.fecha}T${b.hora}:00`));
            
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
            container.style.gap = '2rem';
            
            appointments.forEach(appointment => {
                const appointmentDiv = document.createElement('div');
                appointmentDiv.classList.add('appointment');
                const formattedTime = convertToAMPM(appointment.hora);
                const formattedDate = new Date(appointment.fecha + 'T00:00:00').toLocaleDateString('es-ES', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                
                appointmentDiv.innerHTML = `
                    <div class="appointment-info" id="appointment-info-${appointment.id}">
                        <p><span class="field-title">Barbero:</span> <span class="field-data" style="font-weight: bold; color: #9982BC;">${appointment.barbero}</span></p>
                        <p><span class="field-title">Hora:</span> <span class="field-data">${formattedTime}</span></p>
                        <p><span class="field-title">Nombre:</span> <span class="field-data">${appointment.nombre} ${appointment.apellido}</span></p>
                        <p><span class="field-title">Teléfono:</span> <span class="field-data">${appointment.telefono}</span></p>
                        <p><span class="field-title">Fecha:</span> <span class="field-data">${formattedDate}</span></p>
                        <p><span class="field-title">Servicio:</span> <span class="field-data">${appointment.servicio}</span></p>
                        <div class="appointment-actions">
                            <button onclick="deleteAppointment(${appointment.id}, '${appointment.barbero}')">Eliminar</button>
                            <button onclick="showEditForm(${appointment.id})">Editar</button>
                        </div>
                    </div>
                    <div class="edit-form" id="edit-form-${appointment.id}" style="display: none;">
                        <h3>Editar Cita</h3>
                        <input type="text" id="edit-name-${appointment.id}" value="${appointment.nombre}" placeholder="Nombre">
                        <input type="text" id="edit-surname-${appointment.id}" value="${appointment.apellido}" placeholder="Apellido">
                        <input type="tel" id="edit-phone-${appointment.id}" value="${appointment.telefono}" placeholder="Teléfono">
                        <input type="date" id="edit-date-${appointment.id}" value="${appointment.fecha}">
                        <input type="time" id="edit-time-${appointment.id}" value="${appointment.hora}">
                        <select id="edit-service-${appointment.id}">
                            ${getServiceOptionsForBarbero(appointment.barbero, appointment.servicio)}
                        </select>
                        <div class="appointment-actions">
                            <button onclick="saveEdit(${appointment.id})" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">Guardar</button>
                            <button onclick="cancelEdit(${appointment.id})" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">Cancelar</button>
                        </div>
                    </div>
                `;
                container.appendChild(appointmentDiv);
            });
        }

        // Funciones de edición y eliminación
        function deleteAppointment(id, barberoNombre) {
            if (confirm('¿Estás seguro de que deseas eliminar esta cita?')) {
                fetch(`/api/appointments/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('zahara_auth_token')}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Cita eliminada');
                        applyCurrentFilters();
                    } else {
                        return response.json().then(data => {
                            alert(data.error || 'Error al eliminar la cita');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al eliminar la cita:', error);
                    alert('Error al conectar con el servidor');
                });
            }
        }

        function showEditForm(id) {
            const infoElement = document.getElementById(`appointment-info-${id}`);
            const formElement = document.getElementById(`edit-form-${id}`);
            if (infoElement) infoElement.style.display = 'none';
            if (formElement) formElement.style.display = 'block';
        }

        function cancelEdit(id) {
            const infoElement = document.getElementById(`appointment-info-${id}`);
            const formElement = document.getElementById(`edit-form-${id}`);
            if (infoElement) infoElement.style.display = 'block';
            if (formElement) formElement.style.display = 'none';
        }

        async function saveEdit(id) {
            const nombre = document.getElementById(`edit-name-${id}`)?.value;
            const apellido = document.getElementById(`edit-surname-${id}`)?.value;
            const telefono = document.getElementById(`edit-phone-${id}`)?.value;
            const fecha = document.getElementById(`edit-date-${id}`)?.value;
            const hora = document.getElementById(`edit-time-${id}`)?.value;
            const servicio = document.getElementById(`edit-service-${id}`)?.value;
            
            const barberoNombre = document.querySelector(`#appointment-info-${id} .field-data`).textContent;

            const editedAppointment = {
                nombre,
                apellido,
                telefono,
                fecha,
                hora,
                servicio,
                barbero: barberoNombre
            };

            try {
                const response = await fetch(`/api/appointments/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('zahara_auth_token')}`
                    },
                    body: JSON.stringify(editedAppointment),
                });

                if (response.ok) {
                    alert('Cita actualizada correctamente');
                    applyCurrentFilters();
                } else {
                    const data = await response.json();
                    alert(data.message || 'Ya existe una cita para esta hora, intenta otra hora');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            }
        }

        // Compatibilidad con funciones anteriores
        function filterAppointments() {
            filterByDate();
        }

        function searchAppointments() {
            searchByTerm();
        }

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadAppointments();
        });
    </script>
</body>
</html>